version: '3.8'

services:
  # ----------------------------------------------------
  # 1. SERVI√áO APP (PHP-FPM)
  # Roda a l√≥gica do Laravel.
  # ----------------------------------------------------
  app:
    image: virtusilva/dnshopcell:latest # üö® Troque pela sua imagem Docker customizada
    deploy:
      mode: replicated
      replicas: 1
      placement:
        # Coloca a aplica√ß√£o apenas em workers/managers com a label 'app' (opcional)
        constraints:
          - node.role == worker
      restart_policy:
        condition: on-failure
    volumes:
      # O c√≥digo-fonte √© montado para o Nginx poder acess√°-lo
      - app_data:/var/www/html
    environment:
      # Vari√°veis de ambiente padr√£o do Laravel
      - APP_ENV=production
      - DB_CONNECTION=pgsql # ou mysql
      - DB_HOST=database
      - DB_PORT=5432
      # Adicione seu APP_KEY e outras vari√°veis sens√≠veis aqui (ou use secrets)
      - APP_KEY=base64:.........................

  # ----------------------------------------------------
  # 2. SERVI√áO WEB (NGINX com Traefik)
  # Servidor web que exp√µe a aplica√ß√£o e lida com o Traefik.
  # ----------------------------------------------------
  web:
    image: nginx:stable-alpine # Imagem leve do Nginx
    deploy:
      mode: replicated
      replicas: 1
      # Configura√ß√£o do Traefik para rotear o tr√°fego
      labels:
        # Habilita o Traefik para este servi√ßo
        - "traefik.enable=true"
        # Define o nome do Host (seu dom√≠nio)
        - "traefik.http.routers.laravel-app.rule=Host(`seu-dominio.com`)" # üö® TROQUE SEU-DOMINIO
        # Usa a rede Traefik para comunica√ß√£o
        - "traefik.http.routers.laravel-app.entrypoints=websecure"
        # Habilita HTTPS autom√°tico (certificados via Traefik/LetsEncrypt)
        - "traefik.http.routers.laravel-app.tls.certresolver=le" # 'le' √© o nome do resolver padr√£o
        # Rota para o servi√ßo PHP-FPM
        - "traefik.http.services.laravel-app.loadbalancer.server.port=80" # Nginx roda na porta 80
        
    ports:
      # N√£o √© necess√°rio expor portas diretamente ao host se o Traefik estiver configurado corretamente
      - target: 80
        published: 80 # Para testes locais sem Traefik, mas evite no Swarm
        protocol: tcp
        mode: ingress
        
    volumes:
      # O c√≥digo √© montado a partir do volume do app
      - app_data:/var/www/html
      # Configura√ß√£o Nginx: voc√™ precisar√° de um arquivo Nginx customizado
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    networks:
      - default
      - traefik-public # üö® TROQUE PELO NOME DA SUA REDE EXTERNA DO TRAEFIK

  # ----------------------------------------------------
  # 3. SERVI√áO DE BANCO DE DADOS
  # ----------------------------------------------------
  database:
    image: postgres:15-alpine # ou mysql:8.0
    deploy:
      mode: replicated
      replicas: 1
      # O Banco de dados deve rodar apenas no Manager ou em um n√≥ espec√≠fico
      placement: 
        constraints:
          - node.labels.db == true
    volumes:
      - db_data:/var/lib/postgresql/data # ou /var/lib/mysql
    environment:
      # üö® Configure suas credenciais aqui
      - POSTGRES_DB=laravel_db
      - POSTGRES_USER=laravel_user
      - POSTGRES_PASSWORD=sua_senha_secreta
    networks:
      - default # Rede interna para o app

# ----------------------------------------------------
# 4. REDES E VOLUMES
# ----------------------------------------------------
networks:
  # Rede interna (Docker Swarm)
  default:
    driver: overlay
    attachable: true
  # Rede externa que o Traefik est√° escutando
  traefik-public:
    external: true

volumes:
  # Volume para persistir o c√≥digo/assets (sincronizado)
  app_data:
  # Volume para persistir os dados do BD
  db_data: